<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .image-preview { max-width: 200px; max-height: 200px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ APIè°ƒè¯•é¡µé¢</h1>
        
        <div class="section">
            <h3>1. æµ‹è¯•æ— å›¾ç‰‡ç”Ÿæˆ</h3>
            <textarea id="prompt1" placeholder="è¾“å…¥æç¤ºè¯...">anime figure, cute girl, standing pose</textarea>
            <button onclick="testWithoutImage()">æµ‹è¯•æ— å›¾ç‰‡ç”Ÿæˆ</button>
            <div id="result1" class="log"></div>
        </div>

        <div class="section">
            <h3>2. æµ‹è¯•å¸¦å›¾ç‰‡ç”Ÿæˆ</h3>
            <input type="file" id="imageFile" accept="image/*" onchange="previewImage()">
            <div id="imagePreview"></div>
            <textarea id="prompt2" placeholder="è¾“å…¥æç¤ºè¯...">anime figure based on uploaded image</textarea>
            <button onclick="testWithImage()">æµ‹è¯•å¸¦å›¾ç‰‡ç”Ÿæˆ</button>
            <div id="result2" class="log"></div>
        </div>

        <div class="section">
            <h3>3. æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkServerStatus()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
            <div id="serverStatus" class="log"></div>
        </div>

        <div class="section">
            <h3>4. è¯¦ç»†æ—¥å¿—</h3>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="detailedLogs" class="log"></div>
        </div>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            console.log(logEntry);
            updateDetailedLogs();
        }

        function updateDetailedLogs() {
            const logDiv = document.getElementById('detailedLogs');
            logDiv.innerHTML = logs.map(log => 
                `<div class="${log.type}">${log.message}</div>`
            ).join('');
        }

        function clearLogs() {
            logs = [];
            updateDetailedLogs();
        }

        function previewImage() {
            const file = document.getElementById('imageFile').files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                log(`ğŸ“¸ é€‰æ‹©å›¾ç‰‡: ${file.name}, å¤§å°: ${file.size} bytes, ç±»å‹: ${file.type}`, 'info');
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="é¢„è§ˆ">`;
                    log('âœ… å›¾ç‰‡é¢„è§ˆå·²ç”Ÿæˆ', 'success');
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
                log('âŒ æ²¡æœ‰é€‰æ‹©å›¾ç‰‡', 'error');
            }
        }

        async function testWithoutImage() {
            const prompt = document.getElementById('prompt1').value;
            const resultDiv = document.getElementById('result1');
            
            log(`ğŸš€ å¼€å§‹æµ‹è¯•æ— å›¾ç‰‡ç”Ÿæˆ: "${prompt}"`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('service', 'grsai');
                formData.append('options', JSON.stringify({
                    style: 'anime',
                    pose: 'standing'
                }));

                log('ğŸ“¡ å‘é€è¯·æ±‚åˆ° /api/generate/image', 'info');
                log(`ğŸ“‹ è¯·æ±‚æ•°æ®: prompt="${prompt}", service="grsai"`, 'info');

                const response = await fetch('/api/generate/image', {
                    method: 'POST',
                    body: formData
                });

                log(`ğŸ“Š å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                log(`ğŸ“Š å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ APIè°ƒç”¨å¤±è´¥: ${errorText}`, 'error');
                    resultDiv.innerHTML = `<div class="error">âŒ å¤±è´¥: ${errorText}</div>`;
                    return;
                }

                const result = await response.json();
                log('âœ… APIè°ƒç”¨æˆåŠŸ!', 'success');
                log(`ğŸ“‹ å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`, 'info');

                resultDiv.innerHTML = `
                    <div class="success">âœ… æˆåŠŸ!</div>
                    <div><strong>å›¾ç‰‡URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></div>
                    <div><strong>æœåŠ¡:</strong> ${result.service}</div>
                    <div><strong>è€—æ—¶:</strong> ${result.duration}</div>
                    <div><strong>è¯·æ±‚ID:</strong> ${result.requestId}</div>
                `;

            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function testWithImage() {
            const file = document.getElementById('imageFile').files[0];
            const prompt = document.getElementById('prompt2').value;
            const resultDiv = document.getElementById('result2');
            
            if (!file) {
                log('âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                resultDiv.innerHTML = '<div class="error">âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>';
                return;
            }

            log(`ğŸš€ å¼€å§‹æµ‹è¯•å¸¦å›¾ç‰‡ç”Ÿæˆ: "${prompt}"`, 'info');
            log(`ğŸ“¸ ä½¿ç”¨å›¾ç‰‡: ${file.name}, å¤§å°: ${file.size} bytes`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('service', 'grsai');
                formData.append('options', JSON.stringify({
                    style: 'anime',
                    pose: 'standing'
                }));
                formData.append('file', file);

                log('ğŸ“¡ å‘é€è¯·æ±‚åˆ° /api/generate/image (å¸¦å›¾ç‰‡)', 'info');
                log(`ğŸ“‹ è¯·æ±‚æ•°æ®: prompt="${prompt}", service="grsai", file="${file.name}"`, 'info');

                const response = await fetch('/api/generate/image', {
                    method: 'POST',
                    body: formData
                });

                log(`ğŸ“Š å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                log(`ğŸ“Š å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ APIè°ƒç”¨å¤±è´¥: ${errorText}`, 'error');
                    resultDiv.innerHTML = `<div class="error">âŒ å¤±è´¥: ${errorText}</div>`;
                    return;
                }

                const result = await response.json();
                log('âœ… APIè°ƒç”¨æˆåŠŸ!', 'success');
                log(`ğŸ“‹ å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`, 'info');

                resultDiv.innerHTML = `
                    <div class="success">âœ… æˆåŠŸ!</div>
                    <div><strong>å›¾ç‰‡URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></div>
                    <div><strong>æœåŠ¡:</strong> ${result.service}</div>
                    <div><strong>è€—æ—¶:</strong> ${result.duration}</div>
                    <div><strong>è¯·æ±‚ID:</strong> ${result.requestId}</div>
                    <div><strong>æ–‡ä»¶å:</strong> ${result.name}</div>
                    <div><strong>æ–‡ä»¶å¤§å°:</strong> ${result.size} bytes</div>
                `;

            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">âŒ é”™è¯¯: ${error.message}</div>`;
            }
        }

        async function checkServerStatus() {
            const statusDiv = document.getElementById('serverStatus');
            log('ğŸ” æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...', 'info');
            
            try {
                const response = await fetch('/api/generate/image', {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    log('âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸', 'success');
                    log(`ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯: ${JSON.stringify(data, null, 2)}`, 'info');
                    statusDiv.innerHTML = `
                        <div class="success">âœ… æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</div>
                        <div><strong>æ¶ˆæ¯:</strong> ${data.message}</div>
                        <div><strong>å¯ç”¨æœåŠ¡:</strong> ${JSON.stringify(data.services, null, 2)}</div>
                    `;
                } else {
                    log(`âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`, 'error');
                    statusDiv.innerHTML = `<div class="error">âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}</div>`;
                }
            } catch (error) {
                log(`âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="error">âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.onload = function() {
            log('ğŸš€ è°ƒè¯•é¡µé¢å·²åŠ è½½', 'info');
            checkServerStatus();
        };
    </script>
</body>
</html>

