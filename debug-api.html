<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .image-preview { max-width: 200px; max-height: 200px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 API调试页面</h1>
        
        <div class="section">
            <h3>1. 测试无图片生成</h3>
            <textarea id="prompt1" placeholder="输入提示词...">anime figure, cute girl, standing pose</textarea>
            <button onclick="testWithoutImage()">测试无图片生成</button>
            <div id="result1" class="log"></div>
        </div>

        <div class="section">
            <h3>2. 测试带图片生成</h3>
            <input type="file" id="imageFile" accept="image/*" onchange="previewImage()">
            <div id="imagePreview"></div>
            <textarea id="prompt2" placeholder="输入提示词...">anime figure based on uploaded image</textarea>
            <button onclick="testWithImage()">测试带图片生成</button>
            <div id="result2" class="log"></div>
        </div>

        <div class="section">
            <h3>3. 服务器状态检查</h3>
            <button onclick="checkServerStatus()">检查服务器状态</button>
            <div id="serverStatus" class="log"></div>
        </div>

        <div class="section">
            <h3>4. 详细日志</h3>
            <button onclick="clearLogs()">清空日志</button>
            <div id="detailedLogs" class="log"></div>
        </div>
    </div>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type });
            console.log(logEntry);
            updateDetailedLogs();
        }

        function updateDetailedLogs() {
            const logDiv = document.getElementById('detailedLogs');
            logDiv.innerHTML = logs.map(log => 
                `<div class="${log.type}">${log.message}</div>`
            ).join('');
        }

        function clearLogs() {
            logs = [];
            updateDetailedLogs();
        }

        function previewImage() {
            const file = document.getElementById('imageFile').files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                log(`📸 选择图片: ${file.name}, 大小: ${file.size} bytes, 类型: ${file.type}`, 'info');
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="预览">`;
                    log('✅ 图片预览已生成', 'success');
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
                log('❌ 没有选择图片', 'error');
            }
        }

        async function testWithoutImage() {
            const prompt = document.getElementById('prompt1').value;
            const resultDiv = document.getElementById('result1');
            
            log(`🚀 开始测试无图片生成: "${prompt}"`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('service', 'grsai');
                formData.append('options', JSON.stringify({
                    style: 'anime',
                    pose: 'standing'
                }));

                log('📡 发送请求到 /api/generate/image', 'info');
                log(`📋 请求数据: prompt="${prompt}", service="grsai"`, 'info');

                const response = await fetch('/api/generate/image', {
                    method: 'POST',
                    body: formData
                });

                log(`📊 响应状态: ${response.status}`, response.ok ? 'success' : 'error');
                log(`📊 响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ API调用失败: ${errorText}`, 'error');
                    resultDiv.innerHTML = `<div class="error">❌ 失败: ${errorText}</div>`;
                    return;
                }

                const result = await response.json();
                log('✅ API调用成功!', 'success');
                log(`📋 响应数据: ${JSON.stringify(result, null, 2)}`, 'info');

                resultDiv.innerHTML = `
                    <div class="success">✅ 成功!</div>
                    <div><strong>图片URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></div>
                    <div><strong>服务:</strong> ${result.service}</div>
                    <div><strong>耗时:</strong> ${result.duration}</div>
                    <div><strong>请求ID:</strong> ${result.requestId}</div>
                `;

            } catch (error) {
                log(`❌ 测试失败: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">❌ 错误: ${error.message}</div>`;
            }
        }

        async function testWithImage() {
            const file = document.getElementById('imageFile').files[0];
            const prompt = document.getElementById('prompt2').value;
            const resultDiv = document.getElementById('result2');
            
            if (!file) {
                log('❌ 请先选择图片文件', 'error');
                resultDiv.innerHTML = '<div class="error">❌ 请先选择图片文件</div>';
                return;
            }

            log(`🚀 开始测试带图片生成: "${prompt}"`, 'info');
            log(`📸 使用图片: ${file.name}, 大小: ${file.size} bytes`, 'info');
            
            try {
                const formData = new FormData();
                formData.append('prompt', prompt);
                formData.append('service', 'grsai');
                formData.append('options', JSON.stringify({
                    style: 'anime',
                    pose: 'standing'
                }));
                formData.append('file', file);

                log('📡 发送请求到 /api/generate/image (带图片)', 'info');
                log(`📋 请求数据: prompt="${prompt}", service="grsai", file="${file.name}"`, 'info');

                const response = await fetch('/api/generate/image', {
                    method: 'POST',
                    body: formData
                });

                log(`📊 响应状态: ${response.status}`, response.ok ? 'success' : 'error');
                log(`📊 响应头: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`❌ API调用失败: ${errorText}`, 'error');
                    resultDiv.innerHTML = `<div class="error">❌ 失败: ${errorText}</div>`;
                    return;
                }

                const result = await response.json();
                log('✅ API调用成功!', 'success');
                log(`📋 响应数据: ${JSON.stringify(result, null, 2)}`, 'info');

                resultDiv.innerHTML = `
                    <div class="success">✅ 成功!</div>
                    <div><strong>图片URL:</strong> <a href="${result.url}" target="_blank">${result.url}</a></div>
                    <div><strong>服务:</strong> ${result.service}</div>
                    <div><strong>耗时:</strong> ${result.duration}</div>
                    <div><strong>请求ID:</strong> ${result.requestId}</div>
                    <div><strong>文件名:</strong> ${result.name}</div>
                    <div><strong>文件大小:</strong> ${result.size} bytes</div>
                `;

            } catch (error) {
                log(`❌ 测试失败: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">❌ 错误: ${error.message}</div>`;
            }
        }

        async function checkServerStatus() {
            const statusDiv = document.getElementById('serverStatus');
            log('🔍 检查服务器状态...', 'info');
            
            try {
                const response = await fetch('/api/generate/image', {
                    method: 'GET'
                });

                if (response.ok) {
                    const data = await response.json();
                    log('✅ 服务器运行正常', 'success');
                    log(`📋 服务器信息: ${JSON.stringify(data, null, 2)}`, 'info');
                    statusDiv.innerHTML = `
                        <div class="success">✅ 服务器运行正常</div>
                        <div><strong>消息:</strong> ${data.message}</div>
                        <div><strong>可用服务:</strong> ${JSON.stringify(data.services, null, 2)}</div>
                    `;
                } else {
                    log(`❌ 服务器响应异常: ${response.status}`, 'error');
                    statusDiv.innerHTML = `<div class="error">❌ 服务器响应异常: ${response.status}</div>`;
                }
            } catch (error) {
                log(`❌ 无法连接到服务器: ${error.message}`, 'error');
                statusDiv.innerHTML = `<div class="error">❌ 无法连接到服务器: ${error.message}</div>`;
            }
        }

        // 页面加载时自动检查服务器状态
        window.onload = function() {
            log('🚀 调试页面已加载', 'info');
            checkServerStatus();
        };
    </script>
</body>
</html>

